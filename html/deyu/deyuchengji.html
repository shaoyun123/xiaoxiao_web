<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0" />
		<title>deyuchengji</title>
		<link rel="stylesheet" type="text/css" href=" ../../css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href=" ../../css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href=" ../../css/animate.min.css">
		<link rel="stylesheet" type="text/css" href=" ../../css/bootstrap-switch.min.css">
		<link rel="stylesheet" type="text/css" href="../../css/api.css" />
		<link rel="stylesheet" type="text/css" href="../../css/aui.2.0.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common.css" />
		<script type="text/javascript" src="../../script/jquery.min.js"></script>
		<script type="text/javascript" src="../../script/bootstrap-switch.min.js"></script>
		<style>
			.auiitem {
				list-style: none;
				margin: 0;
				padding: 0;
				color: #212121;
				background-color: #ffffff;
				position: relative;
				min-height: 2.2 rem;
				-webkit-box-sizing: border-box;
				box-sizing: border-box;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-pack: justify;
				-webkit-justify-content: space-between;
				justify-content: space-between;
			}
			header {
				background-color: #f2f2f2;
			}
		</style>
	</head>
	<body>
		<header class="aui-bar aui-bar-nav aui-bar-light" style="background-color: rgba(0, 0, 0, 0);padding-top:25px;color:#CD3700;" id="topbar">
			<a class="aui-pull-left border-b aui-btn" onclick="goback()"> <span class="aui-iconfont aui-icon-info aui-icon-left" style="color:gray;font-size: 20px;"></span> </a>
			<div class="aui-title border-b" style="font-size:20px;color:gray;">
				德育分
			</div>
		</header>
		<div class="aui-content aui-margin-b-15">
			<ul class="aui-list aui-form-list">
				<li class="aui-list-header" style="font-size:20px;background-color: rgba(0, 0, 0, 0);">
					德育成绩
				</li>
				<form id="xuenianxueqi" name="xuenianxueqi" method="post" class="form-horizontal" style="margin-bottom: 10px" role="form" data-toggle="validation" novalidate="novalidate">
					<li class="aui-list-item" style="background-color:rgba(0, 0, 0, 0);">
						<nav>
							<ul id="riqichaxuntiao"></ul>
						</nav>
					</li>
				</form>
				<nav id="n1">
					<ul id="gerendeyu"></ul>
				</nav>
			</ul>
		</div>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript">
		//   关闭页面
		function goback() {
			api.closeWin({
				name : 'deyuchengji',
			});
			api.closeWin({
				name : 'tianxiekaopingbiao',
			});
		}

		apiready = function() {
			api.showProgress({
				title : '努力加载中...',
				text : '先喝杯茶...',
				modal : false
			});
			api.addEventListener({
				name : 'keyback'
			}, function(ret, err) {
				api.closeWin({
					name : 'tianxiekaopingbiao',
				});
				api.closeWin({
					name : 'deyuchengji',
				});
			});
			var dataInfo = $api.getStorage('loginDataInfo');
			var status = dataInfo.status;
			var studentid = dataInfo.id;
			var xuexiaoXuehao = dataInfo.xuexiao_xuehao;
			var banjiid = dataInfo.banJiID;
			var token = $api.getStorage("logintoken");
			var code = studentid + ',zytech,' + xuexiaoXuehao + ',zytech,' + banjiid;
			$.ajax({
				type : "POST",
				url : $api.getStorage('serverUrl') + "app_DeYufengeren",
				data : {
					CODE : code,
					status : status,
					token : token,
				},
				dataType : 'json',
				cache : false,
				success : function(data) {
					var data = eval(data);
					html = "";
					if (data) {
						html += '<li class="auiitem" style="background-color:rgba(0, 0, 0, 0);">';
						html += '<input type="hidden" readonly value="' + xuexiaoXuehao + '" name="xuexiaoXuehao" id="xuexiaoXuehao">';
						html += '<input type="hidden" readonly value="' + banjiid + '" name="banjiid" id="banjiid">';
						html += '<input type="hidden" readonly value="' + token + '" name="token" id="token">';
						html += '<input type="hidden" readonly value="' + status + '" name="status" id="status">';
						html += '<input type="hidden" readonly value="' + studentid + '" name="studentid" id="studentid">';
						html += '<div class="aui-list-item-inner" style="width:50px;"><span style="color:#09c6d0;">学年：</span></div>';
						html += '<div class="aui-list-item-inner" style="width:100px;"><select id="xuenian" name="xuenian" class="form-control chosen-select success" aria-required="true" aria-invalid="false">';
						html += '<option value="">--请选择--</option><option value=2014~2015>2014~2015</option><option value=2015~2016>2015~2016</option><option value=2016~2017>2016~2017</option><option value=2017~2018>2017~2018</option><option value=2018~2019>2018~2019</option></select></div>';
						html += '<div class="aui-list-item-inner" style="width:50px;"><span style="color:#09c6d0;">学期：</span></div>';
						html += '<div class="aui-list-item-inner" style="width:100px;"><select id="xueqi" name="xueqi" class="form-control chosen-select success" aria-required="true" aria-invalid="false">';
						html += '<option value="">--请选择--</option><option value=1>1</option><option value=2 >2</option></select></div>';
						html += '<div class="aui-list-item-inner" style="width:100px;text-align:right;"><div style="text-align:right;">&ensp;<input type="button" class="aui-btn aui-btn-info" onclick="searchResult()" value="查询"></div></div></li>';
						$('#riqichaxuntiao').html(html);
						getzhuangtai();
						if (data.length > 0) {
							xueshenggeren(data);
						} else {
							htmll = '<font style="vertical-align:inherit;font-size:25px;font-weight:bold;">当前学期未发布德育考评</font>';
							$('#gerendeyu').html(htmll);
							api.hideProgress();
						}
					} else {
						alert("已登出");
						api.hideProgress();
						var jsfun = 'logout();';
						api.execScript({
							name : 'index',
							script : jsfun
						});
					}
				},
				error : function() {
					api.hideProgress();
					alert("错误RRR");
				}
			});
		};
		function getzhuangtai() {
			var dataInfo = $api.getStorage('loginDataInfo');
			var status = dataInfo.status;
			var studentid = dataInfo.id;
			var xuexiaoXuehao = dataInfo.xuexiao_xuehao;
			var banjiid = dataInfo.banJiID;
			var token = $api.getStorage("logintoken");
			var code = studentid + ',zytech,' + xuexiaoXuehao + ',zytech,' + banjiid;
			var zhuangtai;
			$.ajax({
				type : "POST",
				url : $api.getStorage('serverUrl') + "app_GetXueNianXueQi",
				data : {
					CODE : code,
					status : status,
					token : token,
				},
				dataType : 'json',
				cache : false,
				success : function(shijian) {
					var shijian = eval(shijian);
					if (shijian) {
						if (shijian.length > 0 && shijian.length == 4) {
							var xuenian = shijian[0];
							var xueqi = shijian[1];
							var zhuangtai = shijian[2];
							var fanganid = shijian[3];
							$("#xuenian").val(xuenian);
							$("#xueqi").val(xueqi);
							$api.setStorage('zhuangtai', zhuangtai);
						} else {
							var xuenian = shijian[0];
							var xueqi = shijian[1];
							$("#xuenian").val(xuenian);
							$("#xueqi").val(xueqi);
						}
					} else {
						alert("已登出");
						api.hideProgress();
						var jsfun = 'logout();';
						api.execScript({
							name : 'index',
							script : jsfun
						});
					}
				},
				error : function() {
					alert("错误KK");
				}
			});
		}

		function xueshenggeren(dypfx_data) {
			var dataInfo = $api.getStorage('loginDataInfo');
			var status = dataInfo.status;
			var studentid = dataInfo.id;
			var xuexiaoXuehao = dataInfo.xuexiao_xuehao;
			var banjiid = dataInfo.banJiID;
			var code = studentid + ',zytech,' + xuexiaoXuehao + ',zytech,' + banjiid;
			var zhuangtai = $api.getStorage('zhuangtai');
			var token = $api.getStorage("logintoken");
			$.ajax({
				type : "POST",
				url : $api.getStorage('serverUrl') + "app_GetBenRendeyu",
				data : {
					CODE : code,
					status : status,
					token : token,
				},
				dataType : 'json',
				cache : false,
				success : function(data) {
					var data = eval(data);
					html = "";
					if (data) {
						$api.setStorage('xuhao_deyu', data.xuehao);
						$api.setStorage('xingming_deyu', data.xingming);
						if (dypfx_data.length != undefined && data.fenshu != undefined) {
							html += '<table id="tab1" class="table table-bordered" style="background-color:#FFFFFF;border: 1px solid #8B8B83;"><thead><tr>';
							for (var i = 0; i < dypfx_data.length; i++) {
								if (dypfx_data[i].shangjiid == 0) {
									html += '<th><font style="vertical-align:inherit;width:400px;">' + dypfx_data[i].mingcheng + '(' + dypfx_data[i].xuefen + '学分)满分' + dypfx_data[i].manfen + '</font></th>';
								}
							}
							html += '<th><font style="vertical-align:inherit;">加权总分</font></th>';
							html += '<th><font style="vertical-align:inherit;">详情</font></th>';
							html += '</tr></thead>';
							html += '<tbody>';
							html += '<tr>';
							for (var i = 0; i < data.fenshu.length; i++) {
								html += '<td><font style="vertical-align:inherit;">' + data.fenshu[i] + '</font></td>';
							}
							html += '<td><font style="vertical-align:inherit;">' + data.deyufen + '</font></td>';
							html += '<td>';
							if (zhuangtai == "1") {
								html += '<input type="button" class="aui-btn aui-btn-info"  onclick="deyugongshi_xiangqing(\'' + data.xuehao + '\',\'' + data.xingming + '\',\'' + data.deyufenid + '\',\'' + data.xueshengid + '\')" value="详情">';
								html += '<input type="button" class="aui-btn aui-btn-info" onclick="deyu_xiugai(\'' + data.xuehao + '\',\'' + data.xingming + '\',\'' + data.deyufenid + '\',\'' + data.xueshengid + '\')" value="修改">';
							} else {
								html += '<input type="button" class="aui-btn aui-btn-info"  onclick="deyugongshi_xiangqing(\'' + data.xuehao + '\',\'' + data.xingming + '\',\'' + data.deyufenid + '\',\'' + data.xueshengid + '\')" value="详情">';
							}
							html += '</td></tr></tbody></table>';
						} else {
							html += '<font style="vertical-align:inherit;font-size:25px;font-weight:bold;">该学生这学期还没填德育分</font>';
						}
					} else {
						alert("已登出");
						api.hideProgress();
						var jsfun = 'logout();';
						api.execScript({
							name : 'index',
							script : jsfun
						});
					}
					$('#gerendeyu').html(html);
					api.hideProgress();
				},
				error : function() {
					api.hideProgress();
					alert("错误RTY");
				}
			});
			$api.rmStorage('zhuangtai');
		}

		function searchResult() {
			if ($("#xuenian").val() == "" || $("#xuenian").val() == "--请选择--") {
				alert("请填学年")
				$("#xuenian").focus();
				return false;
			}
			if ($("#xueqi").val() == "" || $("#xueqi").val() == "--请选择--") {
				alert("请填写学期")
				$("#xueqi").focus();
				return false;
			}
			api.showProgress({
				title : '努力加载中...',
				text : '先喝杯茶...',
				modal : false
			});
			var formData = new FormData($("#xuenianxueqi")[0]);
			$.ajax({
				url : $api.getStorage('serverUrl') + "app_ChaXunByxuenianxueqi",
				type : "post",
				data : formData,
				processData : false,
				contentType : false,
				cache : false,
				success : function(data) {
					var data = eval(data);
					html = "";
					if (data) {
						if (data.zhuangtai != null && data.zhuangtai != "") {
							huoqudeyu(data);
						} else {
							html += '<font style="vertical-align:inherit;font-size:25px;font-weight:bold;">该学期未存在德育分表</font>';
							$('#gerendeyu').html(html);
							api.hideProgress();
						}
					} else {
						alert("已登出");
						api.hideProgress();
						var jsfun = 'logout();';
						api.execScript({
							name : 'index',
							script : jsfun
						});
					}
				},
				error : function() {
					api.hideProgress();
					alert("错误OP");
				}
			});
		}

		function huoqudeyu(dypfx_data) {
			var dataInfo = $api.getStorage('loginDataInfo');
			var status = dataInfo.status;
			var options1 = $("#xuenian option:selected");
			var options2 = $("#xueqi option:selected");
			var xuexiaoXuehao = dataInfo.xuexiao_xuehao;
			var banjiid = dataInfo.banJiID;
			var studentid = $api.getStorage('loginxueshengid');
			var token = $api.getStorage("logintoken");
			var codee = options1.val() + ',zytech,' + options2.val() + ',zytech,' + xuexiaoXuehao + ',zytech,' + studentid;
			$.ajax({
				type : "POST",
				url : $api.getStorage('serverUrl') + "app_WantToDeYuLiuXiang",
				data : {
					CODE : codee,
					banjiid : banjiid,
					status : status,
					token : token,
				},
				dataType : 'json',
				cache : false,
				success : function(data) {
					var data = eval(data);
					html = "";
					if (data) {
						if (dypfx_data.fangAns.length != undefined && data.fenshu != undefined) {
							html += '<table id="tab1" class="table table-bordered" style="background-color:#FFFFFF;border: 1px solid #8B8B83;"><thead><tr>';
							for (var i = 0; i < dypfx_data.fangAns.length; i++) {
								if (dypfx_data.fangAns[i].shangjiid == 0) {
									html += '<th><font style="vertical-align:inherit;width:400px;">' + dypfx_data.fangAns[i].mingcheng + '(' + dypfx_data.fangAns[i].xuefen + '学分)满分' + dypfx_data.fangAns[i].manfen + '</font></th>';
								}
							}
							html += '<th><font style="vertical-align:inherit;">加权总分</font></th>';
							html += '<th><font style="vertical-align:inherit;">详情</font></th>';
							html += '</tr></thead>';
							html += '<tbody>';
							html += '<tr>';
							for (var i = 0; i < data.fenshu.length; i++) {
								html += '<td><font style="vertical-align:inherit;">' + data.fenshu[i] + '</font></td>';
							}
							html += '<td><font style="vertical-align:inherit;">' + data.deyufen + '</font></td>';
							html += '<td>';
							if (dypfx_data.zhuangtai == "1") {
								html += '<input type="button" class="aui-btn aui-btn-info" onclick="deyu_xiugai(\'' + data.xuehao + '\',\'' + data.xingming + '\',\'' + data.deyufenid + '\',\'' + data.xueshengid + '\')" value="修改">';
							} else {
								html += '<input type="button" class="aui-btn aui-btn-info" style="vertical-align:inherit;" onclick="deyugongshi_xiangqing(\'' + data.xuehao + '\',\'' + data.xingming + '\',\'' + data.deyufenid + '\',\'' + data.xueshengid + '\')" value="详情">';
							}
							html += '</td></tr></tbody></table>';
						} else {
							html += '<font style="vertical-align:inherit;font-size:25px;font-weight:bold;">该学生这学期还没填德育分</font>';
						}
					} else {
						alert("已登出");
						api.hideProgress();
						var jsfun = 'logout();';
						api.execScript({
							name : 'index',
							script : jsfun
						});
					}
					$('#gerendeyu').html(html);
					api.hideProgress();
				},
				error : function(e) {
					api.hideProgress();
					alert("错误LL" + e);
				}
			});
		}

		function deyugongshi_xiangqing(xuehao, xingming, deyufenid, xueshengid) {
			api.openWin({
				name : 'deyugongshi_xiangqing',
				url : 'deyugongshi_xiangqing.html',
				pageParam : {
					xuehao : xuehao,
					xingming : xingming,
					deyufenid : deyufenid,
					xueshengid : xueshengid
				},
				reload : true,
				allowEdit : true
			});
		}

		function deyu_xiugai(xuehao, xingming, deyufenid, xueshengid) {
			api.openWin({
				name : 'deyu_xiugai',
				url : 'deyu_xiugai.html',
				pageParam : {
					xuehao : xuehao,
					xingming : xingming,
					deyufenid : deyufenid,
					xueshengid : xueshengid
				},
				reload : true,
				allowEdit : true
			});
		}
	</script>
</html>
